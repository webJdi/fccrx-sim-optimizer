<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCC Riser Optimizer: Human vs AI</title>
    
    <!-- 1. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 2. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 4. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom scrollbar for the logs */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Mobile-specific improvements */
        @media (max-width: 640px) {
            .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const Icons = {
            Minus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
            Snow: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h20"/><path d="M12 2v20"/><path d="m20 20-8.5-8.5"/><path d="m4 20 8.5-8.5"/><path d="m20 4-8.5 8.5"/><path d="m4 4 8.5 8.5"/></svg>,
            Flame: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.113.25-2.18.75-3C9.754 11 8.5 12 8.5 14.5z"/></svg>,
            Pause: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
            Alert: () => <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Brain: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 4.5a2.5 2.5 0 0 0-4.96-.46 2.5 2.5 0 0 0-1.98 3 2.5 2.5 0 0 0-1.32 3 2.5 2.5 0 0 0 0 2.92 2.5 2.5 0 0 0 1.32 3 2.5 2.5 0 0 0 1.98 3 2.5 2.5 0 0 0 4.96-.46 2.5 2.5 0 0 0 4.96.46 2.5 2.5 0 0 0 1.98-3 2.5 2.5 0 0 0 1.32-3 2.5 2.5 0 0 0 0-2.92 2.5 2.5 0 0 0-1.32-3 2.5 2.5 0 0 0-1.98-3 2.5 2.5 0 0 0-4.96.46Z"/><path d="M12 14h.01"/><path d="M9.5 11h.01"/><path d="M14.5 11h.01"/><path d="M12 8h.01"/></svg>,
            List: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Help: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        };

        // What I have tried here is to incorporate a simplified RL model over FCC. If this is over an actual FCC simulator and the policies are further refined, this can be utilized

        // PHYSICS ENGINE (This is a simplified (and gamified) FCC riser model for simulation purposes)
        class FCCUnit {
            constructor() {
                this.temp = 700;           // Riser outlet temperature (in deg C)
                this.feedRate = 50;        // Feed rate (klpd)
                this.catToOilRatio = 5.5;  // Catalyst to oil ratio
                this.pressure = 50;        // Riser pressure (%)
                this.ron = 92.0;          // Research Octane Number
                this.conversion = 70;      // Conversion (%)
                this.cokeYield = 4.5;     // Coke yield (%)
                this.profit = 0;
                this.crashed = false;
                this.time = 0;
            }

            step(action) {
                // Here I have put only five actions. In reality, more granular control would be needed. Cat circulation rate would play a major role, air flowrate would play a major role; Feed quality, bed temperatures will play a major role
                // Actions: 0=Cool, 1=Hold, 2=Heat, 3=LessFeed, 4=MoreFeed
                if (action === 0) this.temp -= 5;
                if (action === 2) this.temp += 5;
                if (action === 3) this.feedRate -= 2;
                if (action === 4) this.feedRate += 2;

                this.temp = Math.max(600, Math.min(850, this.temp));
                this.feedRate = Math.max(10, Math.min(100, this.feedRate));
                
                // 1. Conversion increases with temperature (Arrhenius-like)
                const tempFactor = (this.temp - 600) / 250;  // Normalized 0-1
                this.conversion = 60 + (tempFactor * 25);    // 60-85% range
                
                // 2. Coke yield increases with temperature and conversion
                this.cokeYield = 3 + (tempFactor * 4) + (this.conversion - 70) * 0.1;
                
                // 3. Catalyst to oil ratio affects conversion
                this.catToOilRatio = 4.5 + (this.temp - 700) * 0.01;
                this.catToOilRatio = Math.max(3, Math.min(8, this.catToOilRatio));
                
                // 4. Pressure buildup from feed rate, temperature, and coke formation
                const feedPressure = this.feedRate * 0.5;
                const tempPressure = (this.temp - 600) * 0.15;
                const cokePressure = this.cokeYield * 2;
                this.pressure = feedPressure + tempPressure + cokePressure;
                
                // 5. LCN RON increases with temperature but plateaus
                const ronTemp = 88 + ((this.temp - 650) * 0.05);
                const ronConversion = this.conversion * 0.08;
                this.ron = Math.min(95, ronTemp + (ronConversion - 5.6));

                // ECONOMICS (This is dummy economics; May be replaced with actual economic model)
                const gasolineYield = this.conversion * 0.7; // % of feed converted to gasoline
                const gasolineValue = gasolineYield * (this.ron * 120); // RON premium pricing
                const feedCost = this.feedRate * 80; // Feed cost in INR
                const energyCost = (this.temp - 600) * 0.8; // Heating cost
                const catCost = this.catToOilRatio * 15; // Catalyst circulation cost
                const cokePenalty = this.cokeYield * 50; // Coke handling penalty
                
                const revenue = this.feedRate * gasolineValue; 
                const cost = feedCost + energyCost + catCost + cokePenalty;
                let stepProfit = (revenue - cost)/3600;

                let reward = stepProfit;
                if (this.pressure > 95) {
                    this.crashed = true;
                    reward = -500000; // Large penalty for unit trip
                } else if (this.pressure > 85) {
                    reward -= 5000; // Warning zone penalty
                } else if (this.pressure > 75) {
                    reward -= 1000; // Caution zone
                }

                // Bonus for high conversion with low coke
                if (this.conversion > 75 && this.cokeYield < 5) {
                    reward += 2000;
                }

                this.profit += stepProfit;
                this.time++;

                return {
                    state: this.getStateVector(),
                    reward: reward,
                    done: this.crashed,
                    metrics: {
                        temp: this.temp,
                        feedRate: this.feedRate,
                        pressure: this.pressure,
                        ron: this.ron,
                        conversion: this.conversion,
                        cokeYield: this.cokeYield,
                        catToOilRatio: this.catToOilRatio,
                        stepProfit: stepProfit
                    }
                };
            }

            getStateVector() {
                const pBin = Math.floor(this.pressure / 20);
                const tBin = Math.floor((this.temp - 600) / 50);
                const cBin = Math.floor(this.conversion / 20);
                return `${pBin}-${tBin}-${cBin}`;
            }
            
            reset() {
                this.temp = 700;
                this.feedRate = 50;
                this.catToOilRatio = 5.5;
                this.pressure = 50;
                this.ron = 92.0;
                this.conversion = 70;
                this.cokeYield = 4.5;
                this.profit = 0;
                this.crashed = false;
                this.time = 0;
            }
        }

        // --- 2. Q-LEARNING AGENT ---
        class QLearningAgent {
            constructor() {
                this.qTable = {};
                this.epsilon = 1.0;
                this.alpha = 0.1;
                this.gamma = 0.9;
                this.actions = [0, 1, 2, 3, 4];
            }

            getQ(state) {
                if (!this.qTable[state]) this.qTable[state] = [0, 0, 0, 0, 0];
                return this.qTable[state];
            }

            chooseAction(state) {
                if (Math.random() < this.epsilon) {
                    return this.actions[Math.floor(Math.random() * this.actions.length)];
                } else {
                    const qValues = this.getQ(state);
                    return qValues.indexOf(Math.max(...qValues));
                }
            }

            learn(state, action, reward, nextState) {
                const currentQ = this.getQ(state)[action];
                const maxNextQ = Math.max(...this.getQ(nextState));
                const newQ = currentQ + this.alpha * (reward + this.gamma * maxNextQ - currentQ);
                this.qTable[state][action] = newQ;
            }

            decayEpsilon() {
                if (this.epsilon > 0.05) this.epsilon *= 0.995;
            }
        }

        // --- 3. UI COMPONENTS ---

        const ChartComponent = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                const ctx = canvasRef.current.getContext('2d');
                
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.time),
                        datasets: [
                            {
                                label: 'Pressure %',
                                data: data.map(d => d.pressure),
                                borderColor: '#a855f7',
                                tension: 0.4,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Feed Rate',
                                data: data.map(d => d.feedRate),
                                borderColor: '#3b82f6',
                                tension: 0.4,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Temp C',
                                data: data.map(d => d.temp),
                                borderColor: '#f97316',
                                tension: 0.4,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#94a3b8' }
                            }
                        },
                        scales: {
                            x: {
                                display: false,
                                grid: { display: false }
                            },
                            y: {
                                type: 'linear',
                                display: false,
                                position: 'left',
                                min: 0,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: false,
                                position: 'right',
                                min: 500,
                                max: 900,
                                grid: {
                                    drawOnChartArea: false,
                                },
                            },
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef} />;
        };

        const Gauge = ({ value, max, label, unit, color, warningThreshold }) => {
            const safeValue = (value === undefined || value === null || isNaN(value)) ? 0 : value;
            const percentage = Math.min(100, Math.max(0, (safeValue / max) * 100));
            const isWarning = safeValue > warningThreshold;
            return (
                <div className="flex flex-col items-center p-3 sm:p-4 glass-panel rounded-xl">
                    <span className="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wider mb-2 text-center">{label}</span>
                    <div className="relative w-20 h-20 sm:w-24 sm:h-24 flex items-center justify-center">
                        <svg className="transform -rotate-90 w-full h-full" viewBox="0 0 96 96">
                            <circle cx="48" cy="48" r="40" stroke="#334155" strokeWidth="8" fill="transparent" />
                            <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="transparent" 
                                    className={`${isWarning ? 'text-red-500' : color} transition-all duration-500`}
                                    strokeDasharray={251.2}
                                    strokeDashoffset={251.2 - (251.2 * percentage / 100)}
                            />
                        </svg>
                        <div className="absolute text-base sm:text-xl font-bold text-white">
                            {Math.round(safeValue)}{unit}
                        </div>
                    </div>
                </div>
            );
        };

        const ActionButton = ({ onClick, label, icon, active }) => (
            <button 
                onClick={onClick}
                className={`flex flex-col items-center justify-center p-2 sm:p-3 rounded-lg transition-all duration-200 active:scale-95
                    ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-800 hover:bg-slate-700 text-slate-300'}
                `}
            >
                <div className="mb-1">{icon}</div>
                <span className="text-[10px] sm:text-xs font-medium">{label}</span>
            </button>
        );

        const App = () => {
            const [unit] = useState(() => new FCCUnit());
            const [agent] = useState(() => new QLearningAgent());
            const [mode, setMode] = useState('MANUAL');
            const [simState, setSimState] = useState(() => {
                const res = unit.step(1);
                return { ...res.metrics, crashed: res.done, time: unit.time };
            });
            const [history, setHistory] = useState([]);
            const [decisionLog, setDecisionLog] = useState([]); 
            const [currentQValues, setCurrentQValues] = useState([0, 0, 0, 0, 0]);
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [highScore, setHighScore] = useState(0);
            const intervalRef = useRef(null);

            const runStep = (actionOverride = null) => {
                if (unit.crashed) return;

                const currentStateVec = unit.getStateVector();
                const qValues = agent.getQ(currentStateVec);
                setCurrentQValues([...qValues]); // This updates current Q-values for visualization
                
                let action = (mode === 'AI') ? agent.chooseAction(currentStateVec) : (actionOverride !== null ? actionOverride : 1);

                const result = unit.step(action);

                if (mode === 'AI' || mode === 'MANUAL') {
                    agent.learn(currentStateVec, action, result.reward, result.state);
                    if (mode === 'AI') agent.decayEpsilon();
                }

                // Update Log
                const actionName = ['Cool', 'Hold', 'Heat', 'Feed-', 'Feed+'][action];
                const actionQValue = qValues[action]; 
                    setDecisionLog(prev => [{
                        time: unit.time,
                        action: actionName,
                        reward: result.reward,
                        pressure: Math.round(result.metrics.pressure),
                        qValue: Math.round(actionQValue)
                    }, ...prev].slice(0, 40)); // For keeping last 40 entries

                setSimState({ ...result.metrics, crashed: result.done, time: unit.time });
                setHistory(prev => {
                    const newHist = [...prev, { time: unit.time, ...result.metrics }];
                    if (newHist.length > 50) newHist.shift();
                    return newHist;
                });

                if (result.done) handleCrash();
            };

            const handleCrash = () => {
                clearInterval(intervalRef.current);
                if (unit.profit > highScore) setHighScore(Math.floor(unit.profit));
                if (mode === 'AI') setTimeout(resetSim, 2000);
            };

            const resetSim = () => {
                unit.reset();
                const res = unit.step(1);
                setSimState({ ...res.metrics, crashed: res.done, time: unit.time });
                setHistory([]);
                setDecisionLog([]);
                setCurrentQValues([0, 0, 0, 0, 0]); // Reset Q-values display
                if (mode === 'AI') startLoop();
            };

            const startLoop = () => {
                if (intervalRef.current) clearInterval(intervalRef.current);
                intervalRef.current = setInterval(() => runStep(), 150); // Slightly slower for readability
            };

            const stopLoop = () => {
                if (intervalRef.current) clearInterval(intervalRef.current);
            };

            useEffect(() => {
                if (mode === 'AI') startLoop();
                else stopLoop();
                return () => stopLoop();
            }, [mode]);

            return (
                <div className="min-h-screen p-3 sm:p-4 md:p-8 max-w-6xl mx-auto font-sans">
                    {/* Help Modal */}
                    {showHelpModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowHelpModal(false)}>
                            <div className="glass-panel p-6 sm:p-8 rounded-2xl max-w-2xl max-h-[80vh] overflow-y-auto custom-scrollbar" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-start mb-4 sm:mb-6">
                                    <h2 className="text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">About This Simulator</h2>
                                    <button onClick={() => setShowHelpModal(false)} className="text-slate-400 hover:text-white transition-colors text-2xl leading-none">&times;</button>
                                </div>
                                
                                <div className="space-y-3 sm:space-y-4 text-slate-300 text-xs sm:text-sm">
                                    <div className="flex bg-slate-800 rounded-lg p-1">
                                        <button onClick={() => { setMode('MANUAL'); stopLoop(); }} className={`px-3 sm:px-4 py-1.5 rounded-md text-xs font-bold transition-all flex-1 ${mode === 'MANUAL' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>MANUAL</button>
                                        <button onClick={() => { setMode('AI'); }} className={`px-3 sm:px-4 py-1.5 rounded-md text-xs font-bold transition-all flex-1 ${mode === 'AI' ? 'bg-purple-600 text-white' : 'text-slate-400'}`}>AI PILOT</button>
                                    </div>
                                    <section>
                                        <h3 className="text-base sm:text-lg font-semibold text-white mb-2">What is This?</h3>
                                        <p>This is an interactive Fluid Catalytic Cracking (FCC) Unit simulator that demonstrates <strong>Reinforcement Learning</strong> in action. You can either manually operate the unit or let an AI agent learn to optimize it autonomously.</p>
                                    </section>

                                    <section>
                                        <h3 className="text-base sm:text-lg font-semibold text-white mb-2">FCC Unit Physics</h3>
                                        <p>The simulator models realistic FCC reactor behavior:</p>
                                        <ul className="list-disc pl-5 sm:pl-6 mt-2 space-y-1">
                                            <li><strong>Conversion:</strong> Increases with temperature (60-85% range)</li>
                                            <li><strong>Coke Formation:</strong> Byproduct that increases with temperature and conversion</li>
                                            <li><strong>Pressure:</strong> Function of feed rate, temperature, and coke buildup</li>
                                            <li><strong>RON (Research Octane Number):</strong> Product quality metric, improves with temperature</li>
                                        </ul>
                                    </section>

                                    <section>
                                        <h3 className="text-base sm:text-lg font-semibold text-white mb-2">Your Goal</h3>
                                        <p>Maximize profit (in ₹) while keeping the unit safe. The challenge:</p>
                                        <ul className="list-disc pl-5 sm:pl-6 mt-2 space-y-1">
                                            <li>Higher temperature → Better conversion & RON → More profit</li>
                                            <li>Higher feed rate → More throughput → More profit</li>
                                            <li>BUT: Both increase pressure and coke yield</li>
                                            <li>If pressure exceeds 95%, the unit trips (shuts down)</li>
                                        </ul>
                                        <p className="mt-2 text-emerald-400"><strong>Sweet Spot:</strong> 75%+ conversion with &lt;5% coke yield</p>
                                    </section>

                                    <section>
                                        <h3 className="text-base sm:text-lg font-semibold text-white mb-2">How AI Learns (Q-Learning)</h3>
                                        <p>The AI uses <strong>Q-Learning</strong>, a reinforcement learning algorithm:</p>
                                        <ul className="list-disc pl-5 sm:pl-6 mt-2 space-y-1">
                                            <li><strong>Exploration:</strong> Initially tries random actions to learn</li>
                                            <li><strong>Learning:</strong> Records which actions give the best rewards in each state</li>
                                            <li><strong>Exploitation:</strong> Gradually shifts to using learned optimal actions</li>
                                            <li><strong>Epsilon (ε):</strong> Controls exploration rate (starts at 1.0, decays to 0.05)</li>
                                        </ul>
                                    </section>

                                    <section>
                                        <h3 className="text-base sm:text-lg font-semibold text-white mb-2">Controls</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                                            <div><strong>Cool Down:</strong> Decrease temperature</div>
                                            <div><strong>Heat Up:</strong> Increase temperature</div>
                                            <div><strong>Less Feed:</strong> Reduce feed rate</div>
                                            <div><strong>More Feed:</strong> Increase feed rate</div>
                                            <div><strong>Hold:</strong> Maintain current settings</div>
                                        </div>
                                    </section>

                                    <section className="pt-3 sm:pt-4 border-t border-slate-700">
                                        <p className="text-[10px] sm:text-xs text-slate-500 italic">This is a simplified educational simulator. Real FCC units involve significantly more complex dynamics and safety systems.</p>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 sm:mb-8 gap-4">
                        <div>
                            <h1 className="text-2xl sm:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">FCC Operator</h1>
                            <p className="text-slate-400 text-xs sm:text-sm">Simplied Reinforcement Learning Simulation</p>
                        </div>
                        <div className="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
                            <div className="flex bg-slate-800 rounded-lg p-1 flex-1 sm:flex-initial">
                                <button onClick={() => { setMode('MANUAL'); stopLoop(); }} className={`px-3 sm:px-4 py-1.5 rounded-md text-xs font-bold transition-all flex-1 sm:flex-initial ${mode === 'MANUAL' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>MANUAL</button>
                                <button onClick={() => { setMode('AI'); }} className={`px-3 sm:px-4 py-1.5 rounded-md text-xs font-bold transition-all flex-1 sm:flex-initial ${mode === 'AI' ? 'bg-purple-600 text-white' : 'text-slate-400 animate-pulse'}`}>AI PILOT</button>
                            </div>
                            <button 
                                onClick={() => setShowHelpModal(true)}
                                className="p-2 sm:p-3 glass-panel rounded-full hover:bg-slate-700 transition-all duration-200 active:scale-95 flex-shrink-0"
                                title="About this simulator"
                            >
                                <Icons.Help />
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                        <div className="lg:col-span-2 space-y-4 sm:space-y-6">
                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 max-h-40">
                                <Gauge value={simState.temp} max={900} label="Cat Temperature" unit="°C" color="text-orange-500" warningThreshold={800} />
                                <Gauge value={simState.feedRate} max={120} label="Feed Rate" unit="klpd" color="text-blue-500" warningThreshold={90} />
                                <Gauge value={simState.pressure} max={100} label="Rx Pressure" unit="%" color="text-purple-500" warningThreshold={85} />
                                <Gauge value={simState.ron} max={100} label="LCN RON" unit="" color="text-emerald-500" warningThreshold={999} />
                            </div>

                            <div className="glass-panel p-3 sm:p-4 rounded-xl h-48 sm:h-64 w-full relative">
                                <ChartComponent data={history} />
                            </div>

                            <div className="glass-panel p-4 sm:p-6 rounded-xl">
                                <div className="flex justify-between items-center mb-3 sm:mb-4">
                                    <h2 className="text-base sm:text-lg font-semibold text-white">Operator Controls</h2>
                                </div>
                                {mode === 'MANUAL' ? (
                                    <div className="grid grid-cols-5 gap-2 sm:gap-3">
                                        <ActionButton onClick={() => runStep(3)} label="Less Feed" icon={<Icons.Minus />} />
                                        <ActionButton onClick={() => runStep(0)} label="Cool Down" icon={<Icons.Snow />} />
                                        <ActionButton onClick={() => runStep(1)} label="Hold" icon={<Icons.Pause />} active={true} />
                                        <ActionButton onClick={() => runStep(2)} label="Heat Up" icon={<Icons.Flame />} />
                                        <ActionButton onClick={() => runStep(4)} label="More Feed" icon={<Icons.Plus />} />
                                    </div>
                                ) : (
                                    <div className="text-center py-4 text-purple-300 animate-pulse">
                                        <span className="text-sm sm:text-base">AI Agent is optimizing process parameters...</span><br/>
                                        <span className="text-xs text-purple-400 opacity-70">Exploration Rate (Epsilon): {agent.epsilon.toFixed(3)}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="space-y-4 sm:space-y-6 max-h-40">
                            <div className={`p-4 sm:p-6 rounded-xl text-center transition-colors duration-300 ${simState.crashed ? 'bg-red-900/50 border-red-500 border' : 'bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700'}`}>
                                {simState.crashed ? (
                                    <div>
                                        <div className="text-red-500 mb-2 flex justify-center"><Icons.Alert /></div>
                                        <h2 className="text-xl sm:text-2xl font-bold text-white">UNIT TRIP</h2>
                                        <p className="text-red-300 text-xs sm:text-sm mt-1">Pressure Safety Valve Open</p>
                                        <button onClick={resetSim} className="mt-3 sm:mt-4 bg-red-600 hover:bg-red-500 text-white px-5 sm:px-6 py-2 rounded-full font-bold text-xs sm:text-sm transition-colors">RESET UNIT</button>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="text-slate-400 text-xs uppercase tracking-wider">Current Profit Rate</div>
                                        <div className="text-3xl sm:text-4xl font-bold text-green-400 mt-2">₹{(simState.stepProfit / 1000000).toFixed(2)}<span className="text-base sm:text-lg text-green-600">M/sec</span></div>
                                        <div className="text-slate-500 text-xs mt-2">Total: ₹{(unit.profit / 1000000).toFixed(2)}M</div>
                                    </div>
                                )}
                            </div>

                            {/* Live Decision Feed */}
                            <div className="glass-panel p-3 sm:p-4 rounded-xl flex flex-col min-h-0">
                                <h3 className="text-xs sm:text-sm font-bold text-slate-300 mb-2 sm:mb-3 flex items-center gap-2"><Icons.List /> Live Decision Feed</h3>
                                <div className="overflow-y-auto custom-scrollbar pr-2 space-y-1 flex-1 max-h-48">
                                    {decisionLog.map((log, idx) => (
                                        <div key={`${log.time}-${idx}`} className={`text-xs flex justify-between items-center p-1.5 sm:p-2 rounded border-l-2 ${log.reward < 0 ? 'bg-red-900/20 border-red-500' : 'bg-slate-800/50 border-blue-500'}`}>
                                            <div className="flex-1 min-w-0">
                                                <span className="text-slate-500 mr-1 sm:mr-2 w-6 sm:w-8 inline-block text-[10px] sm:text-xs">T+{log.time}</span>
                                                <span className={`font-bold text-[10px] sm:text-xs ${log.action === 'Hold' ? 'text-slate-400' : 'text-white'}`}>{log.action}</span>
                                                <span className="ml-1 sm:ml-2 text-[9px] sm:text-[10px] text-slate-500">(P:{log.pressure}, Q:{log.qValue})</span>
                                            </div>
                                            <div className={`font-mono font-bold text-[10px] sm:text-xs flex-shrink-0 ml-2 ${log.reward < 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                                                {log.reward > 0 ? '+' : ''}{Math.round(log.reward)}
                                            </div>
                                        </div>
                                    ))}
                                    {decisionLog.length === 0 && <div className="text-center text-slate-600 text-xs italic pt-4">Waiting for data...</div>}
                                </div>
                            </div>

                            <div className="glass-panel p-3 sm:p-4 rounded-xl">
                                <h3 className="text-xs sm:text-sm font-bold text-slate-300 mb-2 sm:mb-3 flex items-center gap-2"><Icons.Brain />AI Brain Activity (Current State Q-Values)</h3>
                                <div className="grid grid-cols-5 gap-1.5 sm:gap-2">
                                    {['Cool', 'Hold', 'Heat', 'Feed-', 'Feed+'].map((actionName, idx) => (
                                        <div key={idx} className="flex flex-col items-center gap-1">
                                            <div className="text-center text-[9px] sm:text-[10px] text-slate-500">{actionName}</div>
                                            <div 
                                                className="w-full h-12 sm:h-16 rounded-md transition-all duration-300 flex items-end justify-center pb-1 relative overflow-hidden"
                                                style={{ 
                                                    backgroundColor: currentQValues[idx] > 0 
                                                        ? `rgba(34, 197, 94, ${Math.min(0.9, Math.abs(currentQValues[idx])/1000)})` 
                                                        : `rgba(239, 68, 68, ${Math.min(0.9, Math.abs(currentQValues[idx])/1000)})`
                                                }}
                                            >
                                                <div className="text-[9px] sm:text-[10px] font-mono font-bold text-white z-10">
                                                    {currentQValues[idx].toFixed(0)}
                                                </div>
                                                {currentQValues[idx] === Math.max(...currentQValues) && currentQValues[idx] !== 0 && (
                                                    <div className="absolute inset-0 border-2 border-yellow-400 rounded-md animate-pulse"></div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-2 sm:mt-3 text-[9px] sm:text-[10px] text-slate-500 text-center">
                                    Highest value indicates the AI's preferred action
                                </div>
                            </div>
                            
                            <div className="text-[10px] sm:text-xs text-slate-500 space-y-2">
                                <p><strong>Goal:</strong> Maximize profit without exploding the unit.</p>
                                <ul className="list-disc pl-4 space-y-1">
                                    <li>High Temp = Better conversion & RON (More ₹) but more coke & pressure.</li>
                                    <li>High Feed = More volume (More ₹) but higher pressure risk.</li>
                                    <li>Sweet spot: 75%+ conversion with &lt;5% coke yield.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>